package io.github.freya022.botcommands.test.commands_kt.slash

import io.github.freya022.botcommands.api.annotations.CommandMarker
import io.github.freya022.botcommands.api.commands.application.ApplicationCommand
import io.github.freya022.botcommands.api.commands.application.GlobalApplicationCommandManager
import io.github.freya022.botcommands.api.commands.application.annotations.AppDeclaration
import io.github.freya022.botcommands.api.commands.application.slash.GuildSlashEvent
import io.github.freya022.botcommands.api.commands.application.slash.annotations.JDASlashCommand
import io.github.freya022.botcommands.api.components.Components
import io.github.freya022.botcommands.api.components.annotations.JDAButtonListener
import io.github.freya022.botcommands.api.components.event.ButtonEvent
import dev.minn.jda.ktx.coroutines.await
import dev.minn.jda.ktx.interactions.components.row
import dev.minn.jda.ktx.messages.reply_
import java.util.concurrent.TimeUnit

private const val TEST_BUTTON_BUTTON_LISTENER_NAME = "MyButton: TestButton"

@CommandMarker
class SlashButton : ApplicationCommand() {
    @JDASlashCommand(name = "button_annotated")
    fun onSlashButton(event: GuildSlashEvent, components: Components) {
        val ephemeral = components
            .primaryButton {
                it.reply_("Button pressed", ephemeral = true).queue()
            }
            .timeout(5, TimeUnit.SECONDS) { event.hook.editOriginalComponents().queue() }
            .addUsers(event.user)
            .build("Test ephemeral")

        val persistent = components.primaryButton(TEST_BUTTON_BUTTON_LISTENER_NAME, "Custom content")
            .timeout(5, TimeUnit.SECONDS)
            .addUsers(event.user)
            .build("Test persistent")

        event.reply_(
            "Buttons !",
//            ephemeral = true,
            components = listOf(row(ephemeral, persistent))
        ).queue()
    }

    @JDAButtonListener(name = TEST_BUTTON_BUTTON_LISTENER_NAME)
    suspend fun onTestButtonClick(event: ButtonEvent, content: String) {
        event.reply_(content, ephemeral = true).await()
    }

    @AppDeclaration
    fun declare(manager: GlobalApplicationCommandManager) {
        manager.slashCommand("button") {
            customOption("components")

            function = ::onSlashButton
        }
    }
}